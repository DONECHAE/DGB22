import streamlit as st
import pandas as pd
import ollama
import matplotlib.pyplot as plt

# Title
st.title('ì†Œë¹„TI ê¸°ë°˜ ESG ê¸ˆìœµ ê²Œì„ í”Œë«í¼')

# Sidebar ë©”ë‰´
st.sidebar.header('ë©”ë‰´')
option = st.sidebar.selectbox('ì„ íƒí•˜ì„¸ìš”', ['ë¯¸ì…˜ ì§„í–‰', 'ì†Œë¹„ ë¶„ì„', 'ë­í‚¹', 'ì¹œí™˜ê²½ ë¯¸ì…˜', 'ì†Œë¹„ ë¦¬í¬íŠ¸'])

# ì‚¬ìš©ì í…ìŠ¤íŠ¸ ê¸°ë°˜ ì†Œë¹„ ë°ì´í„° ì…ë ¥
st.subheader('ì†Œë¹„ íŒ¨í„´ ë¶„ì„')
user_input = st.text_area('ìµœê·¼ ì†Œë¹„ ë‚´ì—­ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì§€ë‚œë‹¬ì—ëŠ” ì‹ë¹„ë¡œ 30ë§Œì›, êµí†µë¹„ë¡œ 10ë§Œì›ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. , ìµœëŒ€í•œ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”!!)')
submit = st.button('ì „ì†¡')

# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
def load_system_prompt():
    return '''
**ì—­í• :**  
ë‹¹ì‹ ì€ ê¸ˆìœµ ë°ì´í„° ë¶„ì„ ë° ê²Œì„í™” ì„¤ê³„ì— ëŠ¥ìˆ™í•œ AI ì „ë¬¸ê°€ì…ë‹ˆë‹¤.  

**ë§¥ë½:**  
ìš°ë¦¬ëŠ” ê¸ˆìœµ ê²Œì„ í”Œë«í¼ì„ ê°œë°œ ì¤‘ì´ë©°, ì‚¬ìš©ì ì†Œë¹„ íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ê°œì¸í™”ëœ ë¯¸ì…˜ì„ ì„¤ê³„í•˜ì—¬ ì ˆì•½ê³¼ ì¹œí™˜ê²½ ì†Œë¹„ë¥¼ ìœ ë„í•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ë ¤ê³  í•©ë‹ˆë‹¤. íŠ¹íˆ, ESG(í™˜ê²½, ì‚¬íšŒ, ì§€ë°°êµ¬ì¡°) ìš”ì†Œë¥¼ ë°˜ì˜í•´ ì‚¬ìš©ìê°€ ì§€ì† ê°€ëŠ¥í•œ ì†Œë¹„ ìŠµê´€ì„ í˜•ì„±í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.  

**ì‘ì—… ì§€ì‹œ:**  
- **ì†Œë¹„ íŒ¨í„´ ë¶„ì„ ë° ë¯¸ì…˜ ì„¤ê³„:**  
  ì‚¬ìš©ìì˜ ììœ ë¡œìš´ í…ìŠ¤íŠ¸ ì†Œë¹„ ë‚´ì—­ì„ ë¶„ì„í•´ ì†Œë¹„ íŒ¨í„´ì„ íŒŒì•…í•˜ê³ , ì ˆì•½ ë° ì¹œí™˜ê²½ ì†Œë¹„ì™€ ê´€ë ¨ëœ ê°œì¸ ë§ì¶¤í˜• ë¯¸ì…˜ì„ ì„¤ê³„í•˜ì„¸ìš”.  
  ì‚¬ìš©ìê°€ ì œê³µí•˜ëŠ” ëª¨ë“  ì†Œë¹„ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ ì ˆì•½ ê°€ëŠ¥ì„±ì´ ë†’ì€ ë¶€ë¶„ì„ ì‹ë³„í•˜ê³ , ì¹œí™˜ê²½ ì†Œë¹„ ë° ì €ì¶•ê³¼ ê´€ë ¨ëœ ì‹¤í–‰ ê°€ëŠ¥í•œ ë¯¸ì…˜ì„ 3ê°€ì§€ ì œì•ˆí•˜ì„¸ìš”.  

**ì¶œë ¥ í˜•íƒœ:**  
- ì‚¬ìš©ìì˜ ì†Œë¹„ íŒ¨í„´ì„ ë¶„ì„í•˜ê³ , ì ˆì•½ ë° ì¹œí™˜ê²½ ì†Œë¹„ë¥¼ ìœ ë„í•˜ëŠ” ë§ì¶¤í˜• ë¯¸ì…˜ì„ ëª©ë¡ í˜•íƒœë¡œ ì‘ì„±í•˜ì„¸ìš”.
- ê° ë¯¸ì…˜ì€ ëª…í™•í•˜ê³  ì¸¡ì • ê°€ëŠ¥í•œ ëª©í‘œë¥¼ í¬í•¨í•˜ì„¸ìš”.
- ë¯¸ì…˜ ë‚œì´ë„ë¥¼ 3ë‹¨ê³„(ì‰¬ì›€, ë³´í†µ, ì–´ë ¤ì›€)ë¡œ êµ¬ë¶„í•˜ê³ , ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡ì„ ëª…ì‹œí•˜ì„¸ìš”.
    '''

# Ollama ì†Œë¹„ íŒ¨í„´ ë¶„ì„ ë° ë¯¸ì…˜ ìƒì„±
def analyze_spending(user_input):
    system_prompt = load_system_prompt()
    try:
        response = ollama.generate(
            model="benedict/linkbricks-llama3.1-korean:8b",
            prompt=f"{system_prompt}\nì‚¬ìš©ì ì…ë ¥: {user_input}",
        )
        return response.get('response', 'ë¶„ì„ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    except Exception as e:
        return f'ì˜¤ë¥˜ ë°œìƒ: {str(e)}'

# ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì‹œ ë¶„ì„ ì‹¤í–‰
if submit and user_input:
    mission = analyze_spending(user_input)
    st.write(f'AI ë¶„ì„ ë¯¸ì…˜: **{mission}**')

# ë¯¸ì…˜ ì§„í–‰
if option == 'ë¯¸ì…˜ ì§„í–‰':
    st.subheader('ğŸŒŸ í˜„ì¬ ë¯¸ì…˜')
    if user_input:
        mission = analyze_spending(user_input)
        st.write(f'AI ë¶„ì„ ë¯¸ì…˜: **{mission}**')
    else:
        st.write('ì†Œë¹„ ë‚´ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')

    if st.button('ë¯¸ì…˜ ì™„ë£Œ'):  
        st.success('ğŸ‰ ë¯¸ì…˜ ì™„ë£Œ! í¬ì¸íŠ¸ +50 ì ë¦½')

# ì†Œë¹„ ë¶„ì„
elif option == 'ì†Œë¹„ ë¶„ì„':
    st.subheader('ğŸ“Š ì†Œë¹„ ë¶„ì„')
    if user_input:
        analysis = analyze_spending(user_input)
        st.write(analysis)
    else:
        st.write('ì†Œë¹„ ë‚´ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')

# ë­í‚¹ ì‹œìŠ¤í…œ
elif option == 'ë­í‚¹':
    st.subheader('ğŸ† ë­í‚¹')
    ranking = {
        'ì‚¬ìš©ì A': 3200,
        'ì‚¬ìš©ì B': 2900,
        'ì‚¬ìš©ì C': 2700
    }
    st.write(pd.DataFrame(list(ranking.items()), columns=['ì‚¬ìš©ì', 'í¬ì¸íŠ¸']))

# ì¹œí™˜ê²½ ë¯¸ì…˜
elif option == 'ì¹œí™˜ê²½ ë¯¸ì…˜':
    st.subheader('ğŸŒ± ì¹œí™˜ê²½ ë¯¸ì…˜ íŠ¸ë˜ì»¤')
    eco_missions = {
        'ëŒ€ì¤‘êµí†µ ì´ìš©': '10íšŒ ì¤‘ 7íšŒ ì™„ë£Œ',
        'ì¼íšŒìš© ì»µ ì‚¬ìš© ì¤„ì´ê¸°': '15íšŒ ì¤‘ 12íšŒ ì™„ë£Œ',
        'ì¥ë°”êµ¬ë‹ˆ ì‚¬ìš©': '20íšŒ ì¤‘ 15íšŒ ì™„ë£Œ'
    }
    for mission, progress in eco_missions.items():
        try:
            current = int(progress.split(' ')[0].replace('íšŒ', ''))
            total = int(progress.split(' ')[2].replace('íšŒ', ''))
            ratio = min(1, current / total)
        except (IndexError, ValueError, ZeroDivisionError):
            ratio = 0
        
        st.write(f'**{mission}**: {progress}')
        st.progress(ratio)

# ì†Œë¹„ ë¦¬í¬íŠ¸ ì‹œê°í™”
elif option == 'ì†Œë¹„ ë¦¬í¬íŠ¸':
    st.subheader('ğŸ“ˆ ì›”ê°„ ì†Œë¹„ ë¦¬í¬íŠ¸')
    st.write('ììœ  í…ìŠ¤íŠ¸ ì…ë ¥ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.')
    if user_input:
        analysis = analyze_spending(user_input)
        st.write(analysis)
    else:
        st.write('ì†Œë¹„ ë‚´ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')

    if st.button('ë¦¬í¬íŠ¸ ì €ì¥'):
        st.success('ë¦¬í¬íŠ¸ê°€ PDFë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!')
