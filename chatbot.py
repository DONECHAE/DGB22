import streamlit as st
import pandas as pd
import ollama
import matplotlib.pyplot as plt
from datetime import datetime
import random
from fpdf import FPDF
from PIL import Image


# íƒ€ì´í‹€ ë° ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
st.title('ğŸ® ê²Œì„ìœ¼ë¡œ ì €ì¶•!')
st.write('### ì¬ë¯¸ìˆê²Œ ì ˆì•½í•˜ê³ , ì†Œë¹„ ìŠµê´€ì„ ë°”ê¿”ë³´ì„¸ìš”!')
st.markdown('---')

# ë¡œì»¬ íŒŒì¼ ê²½ë¡œ ì„¤ì •
local_image_path = r"C:\Users\DC\OneDrive - ê³„ëª…ëŒ€í•™êµ\DC\2024\2024_DGB\chatbot_project\unnamed.png"

# ì´ë¯¸ì§€ ì½ê¸° ë° í‘œì‹œ
try:
    image = Image.open(local_image_path)
    st.sidebar.image(image,  use_container_width=True)
except Exception as e:
    st.sidebar.error("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    st.sidebar.write(str(e))

st.sidebar.header('ğŸ“‹ ë©”ë‰´')
option = st.sidebar.radio('ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•˜ì„¸ìš”', ['ğŸ… ë¯¸ì…˜ ì§„í–‰', 'ğŸ“Š ì†Œë¹„ ë¶„ì„', 'ğŸ† ë­í‚¹', 'ğŸ“ˆ ì†Œë¹„ ë¦¬í¬íŠ¸'])

# ì‹¤ì œ ìˆì„ë²•í•œ í•œ ëª…ì˜ ì†Œë¹„ ë°ì´í„° ìƒì„±
def generate_realistic_data():
    data = {
        'ë‚ ì§œ': pd.date_range(start='2024-01-01', periods=30, freq='D').tolist(),
        'í•­ëª©': [
            'ì»¤í”¼', 'íƒì‹œ', 'ë°°ë‹¬', 'í¸ì˜ì ', 'ì‡¼í•‘', 'êµ¬ë… ì„œë¹„ìŠ¤', 'ì»¤í”¼', 'íƒì‹œ', 'ì˜í™”', 'ì™¸ì‹',
            'ì£¼ìœ ', 'ì‹ë£Œí’ˆ', 'ì±… êµ¬ë§¤', 'ë°°ë‹¬', 'ì˜ë£Œë¹„',
            'ì»¤í”¼', 'í—¬ìŠ¤ì¥', 'í¸ì˜ì ', 'êµ¬ë… ì„œë¹„ìŠ¤', 'ì˜ë¥˜ êµ¬ë§¤', 'íƒì‹œ', 'ì˜í™”', 'ì—¬í–‰', 'í¸ì˜ì ',
            'ì‡¼í•‘', 'ê¸°íƒ€', 'íƒì‹œ', 'êµ¬ë… ì„œë¹„ìŠ¤', 'ì»¤í”¼', 'ì‹ë£Œí’ˆ'
        ],
        'ê¸ˆì•¡': [4500, 12000, 25000, 5800, 32000, 15000, 4000, 13000, 15000, 28000,
                50000, 120000, 27000, 22000, 80000,
                4300, 55000, 6700, 13500, 58000, 13000, 17000, 300000, 7500,
                48000, 12000, 11000, 14500, 4500, 90000
        ],
        'ì¹´í…Œê³ ë¦¬': [
            'í¸ì˜ ì§€ì¶œ', 'êµí†µ', 'ì‹ì‚¬', 'í¸ì˜ ì§€ì¶œ', 'ì‡¼í•‘', 'êµ¬ë… ì„œë¹„ìŠ¤', 'í¸ì˜ ì§€ì¶œ', 'êµí†µ', 'ë¬¸í™”', 'ì™¸ì‹',
            'ì£¼ìœ ', 'ìƒí™œ í•„ìˆ˜', 'êµìœ¡', 'ì‹ì‚¬', 'ì˜ë£Œ',
            'í¸ì˜ ì§€ì¶œ', 'ê±´ê°•', 'í¸ì˜ ì§€ì¶œ', 'êµ¬ë… ì„œë¹„ìŠ¤', 'ì˜ë¥˜', 'êµí†µ', 'ë¬¸í™”', 'ì—¬í–‰', 'í¸ì˜ ì§€ì¶œ',
            'ì‡¼í•‘', 'ê¸°íƒ€', 'êµí†µ', 'êµ¬ë… ì„œë¹„ìŠ¤', 'í¸ì˜ ì§€ì¶œ', 'ìƒí™œ í•„ìˆ˜'
        ]
    }
    df = pd.DataFrame(data)

    def calculate_score(amount):
        if amount <= 10000:
            return 15
        elif amount <= 20000:
            return 35
        elif amount <= 50000:
            return 65
        else:
            return 90

    df['ì†Œë¹„ ì ìˆ˜'] = df['ê¸ˆì•¡'].apply(calculate_score)
    return df

# Ollama ì†Œë¹„ íŒ¨í„´ ë¶„ì„ ë° ë¯¸ì…˜ ìƒì„± (ë‚´ë¶€ ì²˜ë¦¬)
def analyze_spending(data):
    system_prompt = ''' 
**ğŸ§‘â€ğŸ’» ì—­í• :** ê¸ˆìœµ ë°ì´í„° ë¶„ì„ê°€ & ESG ë¯¸ì…˜ ì„¤ê³„ ì „ë¬¸ê°€  
**ğŸŒ ë§¥ë½:** ì‚¬ìš©ìì˜ ê¸ˆìœµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì§€ì¶œì„ ì‹ë³„í•˜ê³ , ì ˆì•½ ë° ì¹œí™˜ê²½ í™œë™ì„ ì´‰ì§„í•˜ëŠ” ë¯¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.

**ğŸ“‹ ì‘ì—… ì§€ì‹œ:**  
1. **ë°ì´í„° ë¶„ë¥˜ ë° ì ìˆ˜ ë¶€ì—¬:**  
   - ì†Œë¹„ ë‚´ì—­ì„ **ì‚¬ì¹˜í’ˆ, í™˜ê²½ ìœ í•´ ì†Œë¹„, í¸ì˜, êµ¬ë… ì„œë¹„ìŠ¤, ì €ì¶•** ë“±ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤.
   - ê° ë²”ì£¼ë³„ë¡œ **ì†Œë¹„ ì ìˆ˜ (0-100ì )**ë¥¼ ì§€ì¶œ ê¸ˆì•¡, ë¹ˆë„, í™˜ê²½ ì˜í–¥ ë“±ì„ ê³ ë ¤í•˜ì—¬ ë¶€ì—¬í•©ë‹ˆë‹¤.

2. **ì„¹í„° ë¶„ë¥˜:**  
   - ì†Œë¹„ ì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ **4ê°œì˜ ì„¹í„°**ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤:
     1. **ì ˆì•½ì´ ë°˜ë“œì‹œ í•„ìš”í•œ ë¶€ë¶„:** ì‚¬ì¹˜í’ˆ, í™˜ê²½ ìœ í•´ ì†Œë¹„
     2. **ì ë‹¹í•œ ì ˆì•½ì´ í•„ìš”í•œ ë¶€ë¶„:** í¸ì˜, êµ¬ë… ì„œë¹„ìŠ¤
     3. **ì ˆì•½ì´ í•„ìš” ì—†ëŠ” ë¶€ë¶„:** ì €ì¶• ë“± í•„ìˆ˜ì ì´ê±°ë‚˜ ê¸ì •ì ì¸ ì†Œë¹„
     4. **ì ˆì•½ì„ í†µí•´ ë” ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„:** ìƒí•„í’ˆ, í¸ì˜

3. **ë¯¸ì…˜ ìƒì„±:**  
   - ê° ì„¹í„°ë³„ë¡œ **ë¯¸ì…˜**ì„ ìƒì„±í•©ë‹ˆë‹¤.
   - ê° ë¯¸ì…˜ì€ ë‹¤ìŒ ìš”ì†Œë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
     - **ë¯¸ì…˜ ì´ë¦„:** ì§ê´€ì ì´ê³  í¥ë¯¸ë¡œìš´ íƒ€ì´í‹€
     - **ëª©í‘œ ë° ì‹¤í–‰ ë°©ë²•:** êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ëª©í‘œ
     - **ë‚œì´ë„:** ì‰¬ì›€ / ë³´í†µ / ì–´ë ¤ì›€
     - **ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡:** ëª…í™•í•œ ê¸ˆì•¡ ì œì‹œ
     - **ë³´ìƒ ë° ì¸ì„¼í‹°ë¸Œ:** í¬ì¸íŠ¸, í• ì¸ ì¿ í° ë“±

**ğŸ“„ ë¯¸ì…˜ í…œí”Œë¦¿:**

---

#### **ë¯¸ì…˜ ì´ë¦„: [ë¯¸ì…˜ ì œëª©]**

- **ëª©í‘œ ë° ì‹¤í–‰ ë°©ë²•:**  
  [êµ¬ì²´ì ì¸ ëª©í‘œì™€ ì‹¤í–‰ ë°©ë²•]

- **ğŸ¯ ë‚œì´ë„:** [ì‰¬ì›€ / ë³´í†µ / ì–´ë ¤ì›€]

- **ğŸ’° ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡:** [ê¸ˆì•¡]

- **ğŸ† ë³´ìƒ ë° ì¸ì„¼í‹°ë¸Œ:**  
  - ê²Œì„ ë‚´ í¬ì¸íŠ¸: [í¬ì¸íŠ¸ ìˆ˜]ì   
  - í• ì¸ ì¿ í°: [ì¿ í° ë‚´ìš©]  
  - ê¸°íƒ€ ë³´ìƒ: [ê¸°íƒ€ ë‚´ìš©]

---

**ì„¹í„° ë¶„ë¥˜ ê¸°ì¤€:**

1. **ì ˆì•½ì´ ë°˜ë“œì‹œ í•„ìš”í•œ ë¶€ë¶„:** ì‚¬ì¹˜í’ˆ, í™˜ê²½ ìœ í•´ ì†Œë¹„
2. **ì ë‹¹í•œ ì ˆì•½ì´ í•„ìš”í•œ ë¶€ë¶„:** í¸ì˜, êµ¬ë… ì„œë¹„ìŠ¤
3. **ì ˆì•½ì´ í•„ìš” ì—†ëŠ” ë¶€ë¶„:** ì €ì¶• ë“± í•„ìˆ˜ì ì´ê±°ë‚˜ ê¸ì •ì ì¸ ì†Œë¹„
4. **ì ˆì•½ì„ í†µí•´ ë” ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„:** ìƒí•„í’ˆ, í¸ì˜

''' 
    try:
        response = ollama.generate(
            model="benedict/linkbricks-llama3.1-korean:8b",
            prompt=f"{system_prompt}\nì†Œë¹„ ë°ì´í„° ë¶„ì„:\n{data.to_string()}"
        )
        return response.get('response', 'ë¯¸ì…˜ ì„¤ê³„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
    except Exception as e:
        return f'ì˜¤ë¥˜ ë°œìƒ: {str(e)}'

# PDF ë¦¬í¬íŠ¸ ìƒì„± í•¨ìˆ˜
def generate_pdf_report(report):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    pdf.cell(200, 10, txt="ì†Œë¹„ ë¦¬í¬íŠ¸", ln=True, align='C')
    pdf.ln(10)
    for index, row in report.iterrows():
        pdf.cell(200, 10, txt=f"{row['ì¹´í…Œê³ ë¦¬']}: {row['ê¸ˆì•¡']}ì›", ln=True)
    return pdf

# ë°ì´í„° ìƒì„± ë° ë¶„ì„
data = generate_realistic_data()
mission = analyze_spending(data)
total_score = data['ì†Œë¹„ ì ìˆ˜'].mean()

if option == 'ğŸ… ë¯¸ì…˜ ì§„í–‰':
    st.subheader('ğŸŒŸ í˜„ì¬ ë¯¸ì…˜')
    st.info('AIê°€ ë¶„ì„í•œ ê²°ê³¼, ì•„ë˜ ë¯¸ì…˜ì„ ì¶”ì²œí•©ë‹ˆë‹¤!')
    with st.expander("ğŸ¯ ë¯¸ì…˜ ë³´ê¸°"):
        st.write(mission)

    if st.button('âœ… ë¯¸ì…˜ ì™„ë£Œ!'):
        st.balloons()
        st.success('ğŸ‰ ë¯¸ì…˜ ì™„ë£Œ! í¬ì¸íŠ¸ +50 ì ë¦½')

elif option == 'ğŸ† ë­í‚¹':
    st.subheader('ğŸ† ì†Œë¹„ ì ìˆ˜ ë­í‚¹')
    ranking = pd.DataFrame({
        'ìˆœìœ„': [1, 2, 3, 4],
        'ì‚¬ìš©ì': ['ì‚¬ìš©ì A', 'ì‚¬ìš©ì B', 'ë‚˜', 'ì‚¬ìš©ì C'],
        'í¬ì¸íŠ¸': [max(total_score + 150, 0), max(total_score + 50, 0), max(total_score, 0), max(total_score - 100, 0)]
    })
    st.table(ranking)
    st.write(f'ğŸ… ë‚˜ì˜ ë­í‚¹: 3ìœ„ | í¬ì¸íŠ¸: {max(total_score, 0):.2f}')

elif option == 'ğŸ“ˆ ì†Œë¹„ ë¦¬í¬íŠ¸':
    st.subheader('ğŸ“ˆ ì†Œë¹„ ë¦¬í¬íŠ¸')
    st.write('### ì¹´í…Œê³ ë¦¬ë³„ ì†Œë¹„ ë‚´ì—­')
    report = data.groupby('ì¹´í…Œê³ ë¦¬')['ê¸ˆì•¡'].sum().reset_index()
    st.dataframe(report)
    if st.button('ğŸ“¥ ë¦¬í¬íŠ¸ PDF ë‹¤ìš´ë¡œë“œ'):
        pdf = generate_pdf_report(report)
        pdf.output("ì†Œë¹„_ë¦¬í¬íŠ¸.pdf")
        st.success('ë¦¬í¬íŠ¸ PDFê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!')
